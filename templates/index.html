<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sender and Data Extractor</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { color: #333; }
        .container { display: flex; flex-direction: column; gap: 2em; }
        .section { border: 1px solid #ccc; padding: 1em; border-radius: 5px; width: 100%; box-sizing: border-box; }
        form { display: flex; flex-direction: column; gap: 1em; }
        label { font-weight: bold; }
        input, textarea, select, button { padding: 0.5em; border: 1px solid #ccc; border-radius: 3px; }
        button { background-color: #007bff; color: white; cursor: pointer; }
        #progress-container { margin-top: 1em; }
    </style>
    <script src="https://cdn.tiny.cloud/1/abjp02aysc6dmxk7b8j6dmqooipdhu66cop01dwbuwjlnssb/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
    <script>
      tinymce.init({
        selector: 'textarea#body',
        plugins: 'lists link image table code help wordcount',
        toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | help'
      });
    </script>
</head>
<body>
    <h1>Email Sender and Data Extractor</h1>
    <div class="container">
        <div class="section">
            <h2>Send Emails</h2>
            <form id="email-form" enctype="multipart/form-data">
                <h3>Email Setup</h3>
                <label for="smtp_host">SMTP Host:</label>
                <input type="text" id="smtp_host" name="smtp_host" value="smtp.etraduceri.eu" required>
                <label for="smtp_port">SMTP Port:</label>
                <input type="number" id="smtp_port" name="smtp_port" value="465" required>
                <label for="smtp_user">SMTP Username:</label>
                <input type="text" id="smtp_user" name="smtp_user" value="contact@etraduceri.eu" required>
                <label for="smtp_pass">SMTP Password:</label>
                <input type="password" id="smtp_pass" name="smtp_pass" required>
                <label for="smtp_secure">Encryption:</label>
                <select id="smtp_secure" name="smtp_secure">
                    <option value="smtps" selected>SMTPS (SSL)</option>
                </select>

                <h3>Email Content</h3>
                <label for="subject">Subject:</label>
                <input type="text" id="subject" name="subject" required>
                <label for="body">Body:</label>
                <textarea id="body" name="body" rows="15"></textarea>

                <h3>Upload Excel File</h3>
                <label for="excel_file">Excel File (with 'email' column):</label>
                <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>

                <button type="submit">Send Emails</button>
            </form>
            <div id="email-progress-container"></div>
        </div>

        <div class="section">
            <h2>Download CECCAR Data</h2>
            <form id="extraction-form">
                <label for="member_region">Select Region:</label>
                <select id="member_region" name="member_region">
                    <option value="-1">All Regions</option>
                    <option value="1">Alba</option>
                    <option value="2">Arad</option>
                    <option value="3">Arges</option>
                    <option value="4">Bacau</option>
                    <option value="5">Bihor</option>
                    <option value="6">Bistrita Nasaud</option>
                    <option value="7">Botosani</option>
                    <option value="8">Brasov</option>
                    <option value="9">Braila</option>
                    <option value="10">Bucuresti</option>
                    <option value="11">Buzau</option>
                    <option value="12">Caras-Severin</option>
                    <option value="13">Calarasi</option>
                    <option value="14">Cluj</option>
                    <option value="15">Constanta</option>
                    <option value="16">Covasna</option>
                    <option value="17">Dambovita</option>
                    <option value="18">Dolj</option>
                    <option value="19">Galati</option>
                    <option value="20">Giurgiu</option>
                    <option value="21">Gorj</option>
                    <option value="22">Harghita</option>
                    <option value="23">Hunedoara</option>
                    <option value="24">Ialomita</option>
                    <option value="25">Iasi</option>
                    <option value="26">Ilfov</option>
                    <option value="27">Maramures</option>
                    <option value="28">Mehedinti</option>
                    <option value="29">Mures</option>
                    <option value="30">Neamt</option>
                    <option value="31">Olt</option>
                    <option value="32">Prahova</option>
                    <option value="33">Satu Mare</option>
                    <option value="34">Salaj</option>
                    <option value="35">Sibiu</option>
                    <option value="36">Suceava</option>
                    <option value="37">Teleorman</option>
                    <option value="38">Timis</option>
                    <option value="39">Tulcea</option>
                    <option value="40">Vaslui</option>
                    <option value="41">Valcea</option>
                    <option value="42">Vrancea</option>
                </select>
                <input type="hidden" id="region_name" name="region_name">
                <button type="submit">Start Extraction</button>
            </form>
            <div id="progress-container"></div>
            <div id="file-history-container">
                <h3>Download History</h3>
                <ul id="file-history-list"></ul>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('email-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const progressContainer = document.getElementById('email-progress-container');
            progressContainer.innerHTML = '<p>Starting to send emails...</p>';

            fetch('/send-emails', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    progressContainer.innerHTML = `<p>An error occurred: ${data.error}</p>`;
                    return;
                }
                const taskId = data.task_id;
                const interval = setInterval(() => {
                    fetch(`/send-emails-status/${taskId}`)
                    .then(response => response.json())
                    .then(statusData => {
                        if (statusData.status === 'running') {
                            progressContainer.innerHTML = `<p>${statusData.progress}</p>`;
                        } else if (statusData.status === 'complete') {
                            clearInterval(interval);
                            progressContainer.innerHTML = `<p>${statusData.message}</p>`;
                        } else if (statusData.status === 'error') {
                            clearInterval(interval);
                            progressContainer.innerHTML = `<p>An error occurred: ${statusData.message}</p>`;
                        }
                    });
                }, 2000);
            });
        });

        document.getElementById('extraction-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const regionSelect = document.getElementById('member_region');
            const regionNameInput = document.getElementById('region_name');
            regionNameInput.value = regionSelect.options[regionSelect.selectedIndex].text;

            const formData = new FormData(this);
            const progressContainer = document.getElementById('progress-container');
            progressContainer.innerHTML = '<p>Starting extraction...</p>';

            fetch('/start-extraction', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const taskId = data.task_id;
                const interval = setInterval(() => {
                    fetch(`/extraction-status/${taskId}`)
                    .then(response => response.json())
                    .then(statusData => {
                        if (statusData.status === 'running') {
                            progressContainer.innerHTML = `<p>${statusData.progress}</p>`;
                        } else if (statusData.status === 'complete') {
                            clearInterval(interval);
                            progressContainer.innerHTML = `<a href="/download-file/${statusData.filename}" download><button>Download File</button></a>`;
                            updateFileHistory();
                        } else if (statusData.status === 'error') {
                            clearInterval(interval);
                            progressContainer.innerHTML = `<p>An error occurred: ${statusData.message}</p>`;
                        }
                    });
                }, 2000);
            });
        });

        function updateFileHistory() {
            fetch('/file-history')
                .then(response => response.json())
                .then(files => {
                    const fileList = document.getElementById('file-history-list');
                    fileList.innerHTML = '';
                    files.forEach(file => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `/download-file/${file}`;
                        a.textContent = file;
                        li.appendChild(a);
                        fileList.appendChild(li);
                    });
                });
        }

        document.addEventListener('DOMContentLoaded', updateFileHistory);
    </script>
</body>
</html>
